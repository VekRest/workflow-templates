name: Reusable CI/CD Workflow Template

on:
  workflow_call:
    inputs:
      sonar_project_key:
        required: true
        type: string
      sonar_org:
        required: true
        type: string
      dockerhub_repo:
        required: true
        type: string
      maven_group:
        required: true
        type: string
      maven_artifact:
        required: true
        type: string
    secrets:
      sonar_token:
        required: true
      dockerhub_user:
        required: true
      dockerhub_token:
        required: true
      release_token:
        required: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:

  #######################################################################
  # 1) TRIVY SCAN
  #######################################################################
  vulnerabilities-scan:
    name: Trivy Vulnerabilities Scan (Security)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
    
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'
    
      - name: Build with Maven (without tests)
        run: mvn clean install -DskipTests

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
    
      - name: Scan for vulnerabilities
        run: |
          trivy fs \
            --scanners vuln \
            --vuln-type library \
            --severity CRITICAL,HIGH \
            --exit-code 1 \
            --ignore-unfixed \
            --format table \
            .

  #######################################################################
  # 2) SONARCLOUD
  #######################################################################
  sonarcloud-analysis:
    name: SonarCloud Analysis (Quality)
    needs: vulnerabilities-scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Analyze with SonarCloud
      - uses: SonarSource/sonarcloud-github-action@v2.2.0
        env:
          SONAR_TOKEN: ${{ secrets.sonar_token }}
        with:
          args:
            -Dsonar.projectKey=${{ inputs.sonar_project_key }}
            -Dsonar.organization=${{ inputs.sonar_org }}
          projectBaseDir: .

      - name: Check SonarCloud Quality Gates
        env:
          SONAR_TOKEN: ${{ secrets.sonar_token }}
          PROJECT_KEY: ${{ inputs.sonar_project_key }}
        run: |
          SONAR_URL="https://sonarcloud.io/api/measures/component?componentKey=$PROJECT_KEY&branch=main"

          # CodeSmells
          CS=$(curl -s -u $SONAR_TOKEN: "$SONAR_URL&metricKeys=code_smells" | jq -r '.component.measures[0].value')
          echo "Code Smell: $CS"
          if [ "$CS" -gt 10 ]; then exit 1; fi

          # Duplicated code
          DUP=$(curl -s -u $SONAR_TOKEN: "$SONAR_URL&metricKeys=duplicated_lines_density" | jq -r '.component.measures[0].value')
          echo "Duplicated: $DUP"
          if (( $(echo "$DUP > 14.0" | bc -l) )); then exit 1; fi

          # Bugs
          BUGS=$(curl -s -u $SONAR_TOKEN: "$SONAR_URL&metricKeys=bugs" | jq -r '.component.measures[0].value')
          echo "Bugs: $BUGS"
          if [ "$BUGS" -gt 2 ]; then exit 1; fi

          # Coverage
          COV=$(curl -s -u $SONAR_TOKEN: "$SONAR_URL&metricKeys=coverage" | jq -r '.component.measures[0].value')
          echo "Coverage: $COV"
          if (( $(echo "$COV < 80.0" | bc -l) )); then echo "LOW COVERAGE"; fi

  #######################################################################
  # 3) DOCKERHUB
  #######################################################################
  dockerhub-publish:
    name: Publish Docker Image (DockerHub)
    needs: sonarcloud-analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set IMAGE_TAG
        id: vars
        run: echo "IMAGE_TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.dockerhub_user }}
          password: ${{ secrets.dockerhub_token }}

      - name: Build with Maven (without tests)
      - run: mvn clean install -DskipTests

      - name: Build & Push DockerHub
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ secrets.dockerhub_user }}/${{ inputs.dockerhub_repo }}:latest
            ${{ secrets.dockerhub_user }}/${{ inputs.dockerhub_repo }}:${{ steps.vars.outputs.IMAGE_TAG }}

      - name: Update DockerHub README
        uses: peter-evans/dockerhub-description@v3
        with:
          username: ${{ secrets.dockerhub_user }}
          password: ${{ secrets.dockerhub_token }}
          repository: ${{ secrets.dockerhub_user }}/${{ inputs.dockerhub_repo }}
          readme-filepath: ./README.md

  #######################################################################
  # 4) MAVEN PACKAGE â€“ GITHUB PACKAGES
  #######################################################################
  github-packages-maven-publish:
    name: Publish Maven Image (Github Pages)
    needs: sonarcloud-analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          server-id: github
          settings-path: ${{ github.workspace }}

      - name: Delete existing package version or whole package (if last version)
        env:
          GH_OWNER: ${{ github.repository_owner }}
          GH_TOKEN: ${{ secrets.release_token }}
          TAG: ${{ github.ref_name }}
          PACKAGE_NAMESPACE: ${{ inputs.maven_group }}
          PACKAGE_NAME: ${{ inputs.maven_artifact }}
        run: |
          echo "ðŸ” Checking for existing package version: $TAG"
  
          PACKAGE_FULL="$PACKAGE_NAMESPACE.$PACKAGE_NAME"
  
          # URL base
          API_BASE="https://api.github.com/orgs/$GH_OWNER/packages/maven/$PACKAGE_FULL"
  
          # ObtÃ©m ID da versÃ£o
          VERSION_ID=$(curl -s -H "Authorization: Bearer $GH_TOKEN" "$API_BASE/versions" \
            | jq ".[] | select(.name==\"$TAG\") | .id")
  
          if [ -z "$VERSION_ID" ]; then
            echo "âœ”ï¸ No version with tag $TAG found. Nothing to delete."
            exit 0
          fi
  
          echo "ðŸ—‘ï¸ Found version ID: $VERSION_ID. Trying to delete version..."
  
          # Tenta deletar a versÃ£o e captura erro
          DELETE_RESPONSE=$(curl -s -o /tmp/delete_output.txt -w "%{http_code}" \
            -X DELETE \
            -H "Authorization: Bearer $GH_TOKEN" \
            "$API_BASE/versions/$VERSION_ID")
  
          if [ "$DELETE_RESPONSE" -eq 204 ]; then
            echo "âœ”ï¸ Version deleted successfully."
            exit 0
          fi
  
          ERROR_MSG=$(cat /tmp/delete_output.txt | jq -r '.message')
  
          if [[ "$ERROR_MSG" == *"You cannot delete the last version of a package"* ]]; then
            echo "âš ï¸ Cannot delete last version. Deleting entire package $PACKAGE_FULL..."
  
            curl -X DELETE \
              -H "Authorization: Bearer $GH_TOKEN" \
              "$API_BASE"
  
            echo "âœ”ï¸ Entire package deleted."
            exit 0
          fi
  
          echo "âŒ Unexpected error deleting version:"
          echo "$ERROR_MSG"
          exit 1

      - name: Build with Maven  (with tests)
        run: mvn -B package
        
      - name: Publish to GitHub Packages Apache Maven
        run: mvn deploy -s $GITHUB_WORKSPACE/settings.xml
        env:
          GITHUB_TOKEN: ${{ secrets.release_token }}

  #######################################################################
  # 5) GHCR â€“ DOCKER
  #######################################################################
  github-packages-docker-publish:
    name: Publish Docker Image (Github Pages)
    needs: sonarcloud-analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install cosign
        uses: sigstore/cosign-installer@v3.5.0

      - name: Log into registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.release_token }}

      - name: Extract Docker metadata
        uses: docker/metadata-action@v5
        id: meta
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: Delete GHCR existing tag
        env:
          OWNER: ${{ github.repository_owner }}
          TOKEN: ${{ secrets.release_token }}
          IMAGE: ${{ env.IMAGE_NAME }}
          TAG: ${{ github.ref_name }}
        run: |
          PKG=$(echo "$IMAGE" | awk -F'/' '{print tolower($NF)}')
          API="https://api.github.com/orgs/$OWNER/packages/container/$PKG"
          LIST=$(curl -s -H "Authorization: Bearer $TOKEN" "$API/versions")
          VER=$(echo "$LIST" | jq ".[] | select(.metadata.container.tags[]?==\"$TAG\") | .id")
          if [ -z "$VER" ]; then exit 0; fi
          curl -X DELETE -H "Authorization: Bearer $TOKEN" "$API/versions/$VER"

      - name: Build with Maven (without tests)
        run: mvn clean install -DskipTests

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        id: build
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          
      - name: Sign the published Docker image
        env:
          TAGS: ${{ steps.meta.outputs.tags }}
          DIGEST: ${{ steps.build.outputs.digest }}
        run: echo "$TAGS" | xargs -I {} cosign sign --yes {}@${DIGEST}

  #######################################################################
  # 6) GITHUB RELEASE
  #######################################################################
  create-release:
    name: Create Release & Generate Changelog
    needs: [dockerhub-publish, github-packages-maven-publish, github-packages-docker-publish]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Release Body with Logs
        id: generate_changelog
        run: |
          CURRENT_TAG=${{ github.ref_name }}
          
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "$CURRENT_TAG^" 2>/dev/null || echo "")
          
          echo "Tag Atual: $CURRENT_TAG"
          echo "Tag Anterior: $PREVIOUS_TAG"
          if [ -z "$PREVIOUS_TAG" ]; then
            LOGS=$(git log --pretty=format:"* %s (%an)" | sed 's/\([A-Za-z0-9]\{7\}\)$//')
            echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
            echo "### ðŸš€ Primeira VersÃ£o" >> $GITHUB_ENV
            echo "" >> $GITHUB_ENV
            echo "Esta Ã© a release inicial do projeto." >> $GITHUB_ENV
            echo "" >> $GITHUB_ENV
            echo "$LOGS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            LOGS=$(git log $PREVIOUS_TAG..$CURRENT_TAG --pretty=format:"* %s (%an)" | sed 's/\([A-Za-z0-9]\{7\}\)$//')
            echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
            echo "### ðŸ› ï¸ Logs de MudanÃ§as ($PREVIOUS_TAG -> $CURRENT_TAG)" >> $GITHUB_ENV
            echo "" >> $GITHUB_ENV
            echo "$LOGS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          body: ${{ env.RELEASE_BODY }}
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          token: ${{ secrets.release_token }}
